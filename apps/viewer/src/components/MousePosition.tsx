import { Card, Group, Text, Tooltip } from "@mantine/core"
import { type PointerEvent, PointerEvents } from "@grx/engine/index"
import { baseUnitsConversionFactor } from "@grx/engine/utils"
import { EditorConfigProvider } from "@src/contexts/EditorContext"
import React, { type JSX } from "react"

type MousePositionProps = {}

export default function MousePosition(_props: MousePositionProps): JSX.Element | null {
  const { units, renderer } = React.useContext(EditorConfigProvider)

  const [x, setX] = React.useState<number>(0)
  const [y, setY] = React.useState<number>(0)

  React.useEffect(() => {
    const handleMouseMove = (e: PointerEvent): void => {
      // DEFAULT UNITS ARE MM
      setX(e.detail.x)
      setY(e.detail.y)
    }
    renderer.pointer.addEventListener(PointerEvents.POINTER_HOVER, handleMouseMove as EventListener)
    renderer.pointer.addEventListener(PointerEvents.POINTER_DOWN, handleMouseMove as EventListener)
    return (): void => {
      renderer.pointer.removeEventListener(PointerEvents.POINTER_HOVER, handleMouseMove as EventListener)
      renderer.pointer.removeEventListener(PointerEvents.POINTER_DOWN, handleMouseMove as EventListener)
    }
  }, [])

  return (
    <Tooltip label={`Units: ${units}`} position="left" withArrow>
      <Card
        mod={["transparent"]}
        withBorder
        style={{
          position: "absolute",
          bottom: 10,
          right: 60,
          pointerEvents: "all",
          width: 275,
          height: 40,
        }}
        padding={6.5}
      >
        <Group grow ml="xs" mr="xs" wrap="nowrap">
          <Group wrap="nowrap">
            <Text c="dimmed">X: </Text>
            {(x / baseUnitsConversionFactor(units)).toFixed(3)}
            {units}
          </Group>
          <Group wrap="nowrap">
            <Text c="dimmed">Y: </Text>
            {(y / baseUnitsConversionFactor(units)).toFixed(3)}
            {units}
          </Group>
        </Group>
      </Card>
    </Tooltip>
  )
}
